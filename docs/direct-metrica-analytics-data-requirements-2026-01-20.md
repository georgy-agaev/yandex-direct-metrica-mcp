# Полный набор данных для анализа эффективности (Direct + Metrica)

Цель: собрать “достаточно полный” набор данных, чтобы ИИ‑агенты могли:
- анализировать результативность кампаний/групп/объявлений/ключей;
- связывать расходы/клики/показы с качеством трафика и конверсиями на посадочных;
- генерировать рекомендации (минус‑слова, перераспределение бюджетов, гипотезы A/B, улучшение посадочных и UTM/треккинга).

## Источники данных

1) **Yandex Direct**
- “Структура” (кампании → группы → объявления → ключи), статусы, ссылки, параметры трекинга.
- “Отчёты” (Reports API) по показам/кликам/расходу + (опционально) конверсиям/доходу.

2) **Yandex Metrica**
- Поведенческие метрики по посадочным (visits, bounce rate, duration, pageviews).
- Конверсии по целям (если цели настроены).
- (Опционально) Logs API для склейки по `yclid` и глубокой атрибуции.

## Что собирать из Direct

### A) Структура (контекст для рекомендаций)
Используется для:
- понимания типов кампаний (поиск/РСЯ/смарт и т.д.);
- анализа статусов (паузы, архив, модерация);
- извлечения URL, UTM‑шаблонов, TrackingParams;
- сопоставления ID ↔ названия (чтобы рекомендации были человеко‑читаемыми).

Инструменты:
- `direct.list_campaigns`
- `direct.list_adgroups`
- `direct.list_ads`
- `direct.list_keywords`

Рекомендация: расширять `field_names` до нужных атрибутов (статусы/типы/параметры ссылок) или использовать `params` для “сырых” payload’ов.

### B) Производительность (основа аналитики)
Инструмент:
- `direct.report` (сырые отчёты в TSV)

Базовые пресеты (см. `docs/report-presets-2026-01-14.md`):
- `CAMPAIGN_PERFORMANCE_REPORT` — результативность по кампаниям
- `ADGROUP_PERFORMANCE_REPORT` — по группам
- `AD_PERFORMANCE_REPORT` — по объявлениям
- `KEYWORDS_PERFORMANCE_REPORT` — по ключам/критериям
- `SEARCH_QUERY_PERFORMANCE_REPORT` — поисковые запросы (для минус‑слов)
- `URL_PERFORMANCE_REPORT` — результативность по целевым URL (для посадочных/треккинга)

Минимально достаточные поля для эффективности:
- `Impressions`, `Clicks`, `Ctr`, `Cost`, `AvgCpc`

Опционально (если нужна “результативность” как конверсии/CPA/ROI):
- `Conversions`, `ConversionRate`, `CostPerConversion`
- `Revenue`, `Roi`

Примечание: доступность конверсий/дохода зависит от настроек целей/дохода и прав. Справка по терминам: `docs/metrics-glossary-2026-01-14.md`.

## Что собирать из Metrica

### A) Посадочные страницы (качество трафика)
Инструменты:
- `metrica.report` (сырые отчёты)
- или HF пресеты: `metrica.hf.report_landing_pages`, `metrica.hf.report_utm_campaigns`, `metrica.hf.report_time_series`

Минимальные метрики (пример):
- `ym:s:visits`, `ym:s:pageviews`, `ym:s:avgVisitDurationSeconds`, `ym:s:bounceRate`

Ключевые разрезы (dimensions):
- `ym:s:startURL` (landing page)
- `ym:s:UTMCampaign`, `ym:s:UTMSource`, `ym:s:UTMMedium` (если используете UTM)
- `ym:s:deviceCategory`, `ym:s:regionCity` (сегментация по девайсу/гео)

### B) Конверсии и цели (для итоговой эффективности)
Нужно определить:
- какие цели считаем результатом (лид/покупка/звонок);
- какие goal IDs использовать в отчётах;
- как интерпретировать “ценность” (если нужен ROI).

Без целей в Метрике “эффективность” будет ограничена кликами/расходом и качеством трафика (bounces, duration, depth).

## Склейка Direct ↔ Metrica (3 варианта)

### Вариант A (самый простой): по UTM
Требование: стабильные UTM в объявлениях/шаблонах.
- Direct: `URL_PERFORMANCE_REPORT` (поле `Url`) + структура/TrackingParams
- Metrica: `ym:s:startURL` + `ym:s:UTMCampaign/Source/Medium`

Плюсы: быстро и дёшево.
Минусы: зависит от дисциплины UTM и нормализации URL.

### Вариант B (самый точный): по `yclid` через Logs API
Требование: доступ к Logs API и корректный сбор click id.
- Direct: расходы/клики/показы
- Metrica Logs: события/визиты по `yclid`

Плюсы: точная связка клика и поведения.
Минусы: сложнее (экспорт, лимиты, хранение выгрузок).

### Вариант C (fallback): без жёсткой склейки
Когда UTM/yclid недоступны, можно:
- анализировать Direct (стоимость/клики/показы) отдельно;
- анализировать посадочные/каналы в Метрике отдельно;
- выводить гипотезы и список “что настроить”, чтобы перейти к варианту A/B.

## Рекомендуемый MVP‑датасет для ИИ‑рекомендаций

На период (например, месяц) собирать:
- Direct:
  - `CAMPAIGN_PERFORMANCE_REPORT` (ежедневно)
  - `AD_PERFORMANCE_REPORT` (ежедневно)
  - `SEARCH_QUERY_PERFORMANCE_REPORT` (ежедневно, если поиск)
  - `URL_PERFORMANCE_REPORT` (ежедневно)
  - структура кампаний/групп/объявлений (хотя бы ID↔Name↔Status↔Type↔URL/TrackingParams)
- Metrica:
  - посадочные по `startURL` + базовые поведенческие метрики
  - UTM отчёты (если используете UTM)
  - цели (если настроены)

## Операционные заметки

- Для конкретного рекламного аккаунта (проекта) в Direct нужен `Client-Login`.
  - По умолчанию это `YANDEX_DIRECT_CLIENT_LOGIN` (логин “по умолчанию” для инстанса).
  - Чтобы “сохранить” несколько проектов и выбирать их в UI, можно задать `YANDEX_DIRECT_CLIENT_LOGINS` (CSV) — это только подсказки/choices.
  - Для мульти‑проектов можно передавать `direct_client_login` в каждом вызове инструмента (override `Client-Login`).
  - Для нескольких проектов есть 3 опции:
    1) несколько `.env` и запусков MCP (по одному `Client-Login`);
    2) один MCP и ручное переключение `YANDEX_DIRECT_CLIENT_LOGIN` перед запуском;
    3) один MCP и `direct_client_login` параметром на каждый вызов (без перезапуска).
- Не хранить пользовательские данные без явной необходимости; токены только через env.

## Вопросы для настройки (нужно уточнить)

1) Какой `YANDEX_METRICA_COUNTER_IDS` относится к этому проекту?
2) Какие цели считаем результатом (и их IDs)?
3) Какая UTM‑стратегия сейчас: уже есть шаблоны или надо внедрять?
