# Changelog

All notable changes to this MCP project will be documented in this file.

## Unreleased
- Bumped version to `0.1.1` and fixed CI install by adding `project.optional-dependencies.dev` (so `pip install -e ".[dev]"` works).
- Refreshed user-facing docs: rewrote `README.md`, added `docs/quickstart.md`, `docs/public-vs-pro.md`, `docs/dashboard-option1.md`, a simple landing page `docs/index.html`, and prompt examples in `examples/claude-code-prompts.md`.
- `README.md`: added a tools/layers overview (raw vs human-friendly), added a CLI commands list, and moved legal/compliance sections to the end.
- Added Apache-2.0 `LICENSE` and an explicit affiliation/trademark disclaimer + “Compliance / Terms” section in `README.md`.
- Moved internal session logs out of the published docs folder (`docs/_sessions_local/`) and excluded from git via `.gitignore`.
- Renamed distribution/image to `yandex-direct-metrica-mcp` (legacy CLI alias kept: `mcp-yandex-ad`).
- Added public read-only mode: `MCP_PUBLIC_READONLY=true` hides write/escape-hatch tools and blocks writes at runtime.
- Added GitHub Actions CI and multi-arch Docker publish workflows (GHCR by default; Docker Hub optional).
- Option 1 dashboard: added a “Требует внимания” alerts block with KPI warning flags for common anomalies (CPL, CTR, bounce, spend vs leads, leads drop).
- Option 1 dashboard: added CPL dynamics to the daily chart (current vs previous period).
- Option 1 dashboard: added per-campaign Leads + CPL columns (best effort via UTMCampaign → CampaignId; only enabled when UTMCampaign report is Direct-only).
- Option 1 dashboard: highlighted the bottleneck step in both funnels (site and Direct) based on the weakest conversion rate in the current period.
- Option 1 dashboard: exposed `metrica.direct_by_campaign` payload for campaign-level leads derived from UTMCampaign (best effort).
- Added beta-ready launch checklist doc for Claude Code + multi-account dashboard runs.
- `dashboard.generate_option1`: added multi-account mode (`all_accounts` / `account_ids`) to generate one dashboard with a top-right account switcher.
- Option 1 dashboard toolbar: reorganized **Период / Сравнение / Кампании / Тема** layout and added a styled account selector when multi-account data is present.
- Option 1 dashboard: split the funnel into two separate blocks — **Site (all sources)** and **Direct (Metrica-attributed)** — to avoid confusing mixed displays like “X → Y (of Z)” and reduce misinterpretation of conversion rates.
- Option 1 dashboard (Option C): enabled **Поиск/РСЯ** split for Direct-attributed Metrica visits/leads via `UTMCampaign` → Direct campaign type mapping, with explicit coverage/missing notes when UTMs are not classifiable.
- Option 1 dashboard (Option C): improved debugability by including unclassified UTMCampaign leads/visits in `metrica.direct_split.meta.top_unclassified_utm` and attempting to filter UTMCampaign reports to Direct-attributed traffic via `lastsignSourceEngine` (fallback to unfiltered on API rejection).
- Option 1 dashboard UI: added `Не классифицировано` to the campaign filter to show the remainder of Direct-attributed Metrica visits/leads that could not be mapped to Search/RSYA via UTMCampaign (CPL is intentionally not calculated there).
- Option 1 dashboard goals: added previous-period overlay for the goals chart and enabled the Direct/All sources toggle (best effort) by providing a capped per-goal breakdown for Direct traffic while keeping “All goals” in Direct scope based on `sumGoalReachesAny`.
- Option 1 dashboard sources: switched to a more distinct color palette and assigned fixed colors for key sources (Search / Direct / Other) to avoid visually ambiguous “same-ish” series colors on one chart.
- Option 1 dashboard campaigns filter: the `Все / Поиск / РСЯ` toggle now refreshes the whole dashboard for Direct metrics (charts/table). Direct-attributed steps use Option C mapping; if UTMs are not classifiable, the UI shows partial coverage/missing.
- Option 1 dashboard layout: moved **Рекомендации** under **Динамика по дням** and made both sections full-width; added an explicit note explaining UTMCampaign coverage/missing for the Direct funnel under `Поиск/РСЯ`.
- Fixed `dashboard.generate_option1` and `scripts/generate_dashboard_option1.py` to treat Direct report `Cost` as RUB (and derive `cost_micros`), fixing near-zero cost displays in generated dashboards.
- Fixed a blank-screen issue in the Option 1 BI dashboard template caused by calling `updateDashboard()` during initial theme setup (JS TDZ error).
- `dashboard.generate_option1` now supports `return_data` (defaults to `false` when `output_dir` is set) to avoid token-limit failures in chat clients while still writing HTML/JSON files.
- Fixed compact `summary` extraction for `return_data=false` (totals are taken from `direct.current.totals` / `metrica.current.totals`).
- Added Metrica “sources” breakdown (lastSignTrafficSource + lastSignSourceEngine) to Option 1 dashboard to mirror Direct Pro-style source detail (search/direct/ad engines + other remainder).
- Added Metrica “goals” breakdown to Option 1 dashboard (per-goal reaches series and a goals chart/table when `goal_ids` is provided).
- When `goal_ids` is omitted, Option 1 dashboard now tries to include “all goals” (best effort) via `ym:s:date,ym:s:goal` + `ym:s:sumGoalReachesAny`.
- Fixed funnel conversion/CPA logic to use Direct-attributed visits/leads (instead of all-site visits), preventing misleading “cost per lead” when non-ad traffic dominates.
- Expanded dashboard data to include derived Direct KPIs (CTR/CPC/CPM) and additional Metrica metrics (users, bounce rate, depth, avg visit duration seconds) for richer dashboards.
- Reworked `dashboard.generate_option1` HTML to include previous-period comparison, a funnel block, and a richer campaigns table; added optional `goal_ids` to compute leads from Metrica goals (best effort).
- `dashboard.generate_option1` now auto-excludes the current day by shifting `date_to` to yesterday when `date_to` is today or in the future.
- Clarified that the BI dashboard is generated by a local script (not an MCP tool) and documented SSE prerequisite in `docs/claude-code-setup-2026-01-27.md`.
- Added MCP utility tool `dashboard.generate_option1` to generate the BI dashboard (Option 1) directly via MCP.
- Fixed Direct report param builder to put `DateFrom`/`DateTo` into `SelectionCriteria` (required by `/json/v501/reports`).
- Added tool coverage snapshot doc (`docs/tool-coverage-2026-01-27.md`).
- Documented `accounts.json` registry format and usage (`docs/accounts-registry-2026-01-27.md`).
- Added usage examples for `account_id` and `join.hf.*` (`docs/usage-examples-2026-01-16.md`).
- Upgraded `join.hf.direct_vs_metrica_by_utm` to return a joined daily series (Direct performance + Metrica visits) using UTMCampaign filter.
- Implemented `join.hf.direct_vs_metrica_by_yclid` best-effort join: Logs API export/download + Direct click id report join, with bounds and resumable `request_id`.
- Added unit tests for join HF tools.
- Escaped UTMCampaign filter values for Metrica joins and documented yclid join limitations.
- Added dashboard generator (Option 1) script + HTML template.
- Improved `join.hf.direct_vs_metrica_by_yclid` to fall back to extracting `yclid` from `ym:s:startURL` when `ym:s:yclid` is not available in Logs API.
- Added a practical fallback for `join.hf.direct_vs_metrica_by_yclid`: join via `ym:s:lastDirectClickBanner` → Direct `ads.get` (ad id → campaign id) when Direct click-id report fields are unsupported.
- Added Claude Code setup guide for this MCP (`docs/claude-code-setup-2026-01-27.md`).
- Added multi-account registry via `MCP_ACCOUNTS_FILE` (`account_id` -> Direct `Client-Login` + optional default Metrica counter ids).
- Added `account_id` argument to `direct.*`, `metrica.*`, and `join.hf.*` tool schemas and runtime resolution in the server.
- Added `accounts.*` tools (`accounts.list`, `accounts.reload`, `accounts.upsert`, `accounts.delete`) to manage project profiles via MCP; writes are guarded by `MCP_ACCOUNTS_WRITE_ENABLED`.
- Updated `docker-compose.yml` to mount external state (`/Users/georgyagaev/mcp/state/yandex.ad`) so secrets/config aren’t baked into the image.
- Added unit tests for accounts registry loading and schema injection.
- Added `scripts/check_direct_access.py` for a minimal Direct credentials/access check.
- Made `scripts/validate_env.py`, `scripts/health_check.py`, and `scripts/smoke_test.py` load `.env` by default.
- Added per-call Direct `Client-Login` override via `direct_client_login` argument for `direct.*` and `join.hf.*` tools (multi-project support).
- Added `YANDEX_DIRECT_CLIENT_LOGINS` (CSV) to store multiple Direct client logins for UI selection.
- Added Direct API `v501` support via `YANDEX_DIRECT_API_VERSION` (Unified campaigns).
- Fixed SSE transport for `mcp` v1.25 (Starlette + `SseServerTransport`).
- Normalized callout handling for `ads.add` vs `ads.update` (`TextAd.AdExtensions` vs `TextAd.CalloutSetting`).
- Added write guard enforcement for `direct.raw_call` non-GET methods.
- Fixed Direct `sitelinks.get` / `vcards.get` behavior for `v501` (Ids required).
- Added seed/attach scripts for a full draft flow (`scripts/mcp_seed_test_energy.py`, `scripts/mcp_attach_assets_test_energy.py`).
- Added `.dockerignore` to reduce Docker build context.
- Added Direct management recipes and scripts (bids, negative keywords) using `direct.raw_call` + existing tools.
- Added management scripts for budget/strategy patching, bid modifiers, autotargeting bid, and UTM templates applied to ad URLs.
- Initial documentation structure and research artifacts.
- Added Python MCP skeleton and roadmap.
- Added write guardrails (MCP_WRITE_ENABLED, MCP_WRITE_SANDBOX_ONLY).
- Added health check script and Docker Compose config.
- Added config/write guard unit tests.
- Added normalized error payloads for Direct/Metrica failures.
- Added unit tests for error normalization.
- Added required-parameter validation for dictionaries/changes/metrica reports.
- Added unit tests for parameter validation.
- Added required-parameter validation for Direct reports.
- Normalized errors for missing client configuration.
- Added required-parameter validation for Metrica metrics.
- Added required-parameter validation for Logs API date range.
- Added required-parameter validation for Logs API fields/source.
- Added normalized error response example and clarified Logs API validation notes.
- Added required fields to MCP tool schemas for reports and logs.
- Added required-field notes to usage examples.
- Added required field to Direct raw_call tool schema.
- Added usage examples for dictionaries, changes, and raw calls.
- Added usage examples for additional Direct tools (ad groups, keywords, bids, etc).
- Added Metrica report examples for landing pages and UTM campaigns.
- Added validation checklist entries for landing pages and UTM reports.
- Added unit tests for logs/raw-call parameter validation.
- Added Direct report presets document.
- Added JSON examples to Direct report presets.
- Added summary table to Direct report presets.
- Added env validation warning for missing Direct client login.
- Added auth troubleshooting notes to setup guide.
- Added common error hints to setup guide.
- Added Direct error response example to usage docs.
- Added retry/backoff guidance to setup guide.
- Added client-side retry pseudo-code example.
- Added Direct report retry note to usage docs.
- Added Direct pagination example to usage docs.
- Added paging note to Metrica report usage example.
- Added sampling/accuracy note to Metrica report usage example.
- Added metrics glossary for commonly used fields.
- Expanded metrics glossary with conversion and bounce metrics.
- Added cost per conversion to metrics glossary.
- Added revenue and ROI to metrics glossary.
- Clarified prerequisites for conversion and revenue metrics.
- Added goals/ecommerce prerequisites to setup guide.
- Added UTM mapping strategy note to setup guide.
- Added yclid-based join notes for Logs API.
- Added Logs API yclid join example to usage docs.
- Added Logs API workflow example to usage docs.
- Added Logs API clean/cancel examples to usage docs.
- Added Logs API status and multi-part download notes.
- Added Logs API cleanup note to usage docs.
- Added sampling/accuracy guidance to setup guide.
- Added Metrica metrics vs dimensions cheat sheet.
- Expanded Metrica glossary with UTM, device, and geo dimensions.
- Added Metrica report examples for UTM source/medium, device, and city.
- Added combined Direct + Metrica workflow example.
- Added yclid-based join workflow example using Logs API.
- Added click identifier validation note for yclid joins.
- Added field mapping checklist for Direct + Metrica joins.
- Added timezone note to field mapping checklist.
- Added URL normalization note to field mapping checklist.
- Added UTM normalization note to field mapping checklist.
- Added data normalization tips doc.
- Added Direct cost unit conversion note to data normalization tips.
- Added currency and timezone alignment notes to data normalization tips.
- Clarified multi-counter and agency login notes in setup and validation.
- Added guidance for single Direct login per server instance.
- Added Docker example for running multiple instances.
- Added transport notes for stdio vs SSE in setup guide.
- Added env file and logging tips to setup guide.
- Added logging safety note to setup guide.
- Added Direct create/update tools for campaigns, ad groups, ads, and keywords.
- Added write support to tool schemas and server handlers.
- Added write validation examples and checklist updates.
- Added Direct report presets and data/field mapping docs for joins.
- Added Metrica management raw call examples for create/update.
- Added API application description doc for Direct access request.
- Avoided truthiness checks for Yandex clients in server/smoke test.
- Implemented `direct.list_campaigns` tool handler.
- Implemented `direct.list_adgroups`, `direct.list_ads`, and `direct.list_keywords` tool handlers.
- Implemented `direct.report` tool handler.
- Implemented `direct.list_clients` tool handler.
- Implemented `direct.list_dictionaries` tool handler.
- Implemented `direct.get_changes` tool handler.
- Implemented `direct.list_sitelinks` tool handler.
- Implemented `direct.list_vcards` tool handler.
- Implemented `direct.list_adextensions` tool handler.
- Implemented `direct.list_bids` tool handler.
- Implemented `direct.list_bidmodifiers` tool handler.
- Implemented Metrica tool handlers (list counters, counter info, report, logs export).
- Added token refresh unit tests.
- Added Dockerfile and local setup instructions.
- Added MCP usage examples.
- Added `.env.example` template.
- Added environment validation script.
- Implemented raw call tools for Direct and Metrica.
- Added smoke test script.
- Updated README with setup and usage pointers.
- Added OAuth code exchange script.
- Added validation checklist for real-credential testing.
